<!DOCTYPE html>
<html lang="en" ng-app="app">
<head>
   <base href="/">
   <meta charset="utf-8">
   <meta name="viewport" content="width=device-width, minimum-scale=1.0">
   <title>Examiner</title>
   <meta name="description" content="">
   <link href="humans.txt" type="text/plain" rel="author">
   <link href="css/default.min.css" rel="stylesheet">
   <link href="//fonts.googleapis.com" rel="dns-prefetch">
   <link href="//fonts.googleapis.com/css?family=PT+Sans:400,400italic&amp;subset=latin,latin-ext" rel="stylesheet">
   <link href="//fonts.googleapis.com/css?family=PT+Sans+Narrow:400,700&amp;subset=latin,latin-ext" rel="stylesheet">
   <link href="//fonts.googleapis.com/css?family=Roboto:300,400,400italic&amp;subset=latin,latin-ext" rel="stylesheet">
   <!--[if lte IE 9]><script src="js/shims.min.js"></script><![endif]-->

</head>
<body>

<div class="layout-wrapper">

   <header class="page-header">

      <h1 class="site-logo"><a href=""></a></h1>

      <nav class="top-nav">
         <ul class="inline-list">
            <li>Logged in as &ndash; <a href="">havelad1</a></li>
            <li><a href="">Preferences</a></li>
            <li><a href="">Log Out</a></li>
         </ul>
      </nav>

      <span class="time">1:56</span>

   </header>

   <aside class="sidebar">

      <nav class="site-nav">
         <ul class="block-list">
            <li><a class="site-nav__item icon--write" ui-sref="home" ui-sref-active="ng-active">Current</a></li>
            <li><a class="site-nav__item icon--tick" href="">Evaluate</a></li>
            <li><a class="site-nav__item icon--exams" ui-sref="blueprints" ui-sref-active="ng-active">Blueprints</a></li>
            <li><a class="site-nav__item icon--create" href="">Create</a></li>
            <li><a class="site-nav__item icon--results" href="">Results</a></li>
         </ul>
      </nav>

   </aside>

   <section class="main-content" role="main" ui-view></section>

   <footer class="page-footer"></footer>

</div>
<script src="js/app.min.js"></script>
<script>

   function getElements(selector, parent) {
      parent = parent || document;
      var elements = parent.querySelectorAll(selector),
          arr = [];
      for (var i = elements.length; i--; arr.unshift(elements[i]));
      return arr;
   }

   var codeBlocks = getElements('.j-code');

   Modernizr.load({
      test: codeBlocks.length,
      yep: 'js/ondemand/app.highlight.min.js',
      callback: function init() {

         Prism.highlightAll();

         codeBlocks.forEach(function(block) {

            block.addEventListener('keydown', function(e) {

               if (e.keyCode == 9) {
                  e.preventDefault();
                  document.execCommand('InsertHTML', false, '   ');
               } else if (e.keyCode == 13) {
                  e.preventDefault();
                  document.execCommand('InsertHTML', false, '\n');
               }

            });

            block.addEventListener('input', function(e) {
               var code = this.firstChild;
               var text = code.innerText;
               code.innerText = text;
               //Prism.highlightElement(this);
            });

         });

      }
   });

   var canvasWrappers = getElements('.j-canvas');

   Modernizr.load({
      test: canvasWrappers.length,
      yep: 'js/ondemand/app.canvas.min.js',
      callback: function init() {

         canvasWrappers.forEach(function(canvasWrapper) {

            var canvas = canvasWrapper.querySelector('canvas'),
                canvasTools = getElements('.j-canvas-tool', canvasWrapper),
                isMouseDown = false,
                pointer,
                obj;

            canvas.width = canvasWrapper.clientWidth;
            canvas.height = canvas.width / (16/9);

            /*var canvasTools = [
               {
                  name: 'select',
                  icon: 'arrow',
                  onClick: function() {
                     (activateTool.bind(this))(selectHandler);
                  }
               }
            ];

            var canvasToolsElement = document.createElement('ul');

            canvasWrapper.appendChild(canvasToolsElement);*/

            canvas = new fabric.Canvas(canvas.id, {
               selection: false,
               defaultCursor: 'crosshair'
            });
            canvas.calcOffset();

            var History = (function(canvas) {

               var api = {};

               var states = [JSON.stringify(canvas)],
                   currentState = 0,
                   limit = 25;

               api.canUndo = function() {
                  return (currentState > 0);
               };

               api.canRedo = function() {
                  return (currentState < states.length - 1);
               };

               api.undo = function() {
                  if (api.canUndo()) {
                     canvas.getObjects().forEach(function(obj) {
                        canvas.remove(obj);
                     });
                     canvas.loadFromJSON(states[--currentState]);
                     if (!canvas.selection) {
                        canvas.getObjects().forEach(function(obj) {
                           obj.set({
                              selectable: false
                           });
                           obj.setCoords();
                        });
                     }
                     canvas.renderAll();
                  }
               };

               api.redo = function() {
                  if (api.canRedo()) {
                     canvas.getObjects().forEach(function(obj) {
                        canvas.remove(obj);
                     });
                     canvas.loadFromJSON(states[++currentState]);
                     if (!canvas.selection) {
                        canvas.getObjects().forEach(function(obj) {
                           obj.set({
                              selectable: false
                           });
                           obj.setCoords();
                        });
                     }
                     canvas.renderAll();
                  }
               };

               (function init() {

                  canvas.on('object:modified', function(e) {
                     if (currentState < states.length - 1) {
                        states = states.slice(0, currentState + 1);
                     }
                     if (currentState < limit - 1) {
                        currentState++;
                     }
                     if (states.length === limit) {
                        states.shift();
                     }
                     states.push(JSON.stringify(canvas));
                  });

               })();

               return api;
            })(canvas);

            var activateTool = function(toolHandler) {
               if (!this.classList.contains('j-active')) {

                  canvasTools.forEach(function(tool) {
                     tool.classList.remove('j-active');
                  });
                  this.classList.add('j-active');

                  canvas.deactivateAllWithDispatch();
                  canvas.selection = false;
                  canvas.getObjects().forEach(function(obj) {
                     obj.set({
                        editable: false,
                        selectable: false
                     });
                  });

                  canvas.isDrawingMode = false;
                  canvas.defaultCursor = 'crosshair';

                  canvas.off('mouse:down');
                  canvas.off('mouse:move');
                  canvas.off('mouse:up');

                  if (toolHandler.mouseDown) {
                     canvas.on('mouse:down', toolHandler.mouseDown);
                  }
                  if (toolHandler.mouseMove) {
                     canvas.on('mouse:move', toolHandler.mouseMove);
                  }
                  if (toolHandler.mouseUp) {
                     canvas.on('mouse:up', toolHandler.mouseUp);
                  }
                  if (toolHandler.init) {
                     toolHandler.init();
                  }

                  canvas.renderAll();
               }
            }

            var selectHandler = {
               init: function() {
                  canvas.defaultCursor = 'default';
                  canvas.selection = true;
                  canvas.getObjects().forEach(function(obj) {
                     obj.set({
                        selectable: true
                     });
                     obj.setCoords();
                  });
               },
               mouseDown: function(o) {
                  canvas.calcOffset();
               }
            };

            var paintHandler = {
               init: function() {
                  canvas.on('path:created', function(e) {
                     e.path.set({
                        perPixelTargetFind: true
                     });
                     canvas.fire('object:modified', { target: e.path });
                  });
                  canvas.isDrawingMode = true;
               },
               mouseDown: function(o) {
                  canvas.calcOffset();
               }
            };

            var rectHandler = {
               mouseDown: function(o) {
                  canvas.calcOffset();
                  isMouseDown = true;
                  pointer = canvas.getPointer(o.e);
                  obj = new fabric.Rect({
                     strokeWidth: 2,
                     fill: 'rgba(255, 255, 255, .25)',
                     stroke: 'rgba(0, 0, 0, .75)',
                     originX: 'left',
                     originY: 'top',
                     top: pointer.y,
                     left: pointer.x,
                     selectable: false,
                     perPixelTargetFind: true
                  });
                  canvas.add(obj);
               },
               mouseMove: function(o) {
                  if (!isMouseDown) {
                     return;
                  }
                  var currentPointer = canvas.getPointer(o.e);
                  obj.set({
                     width: currentPointer.x - pointer.x,
                     height: currentPointer.y - pointer.y
                  });
                  canvas.renderAll();
               },
               mouseUp: function(o) {
                  isMouseDown = false;
                  canvas.fire('object:modified', { target: obj });
               }
            };

            var circleHandler = {
               mouseDown: function(o) {
                  canvas.calcOffset();
                  isMouseDown = true;
                  pointer = canvas.getPointer(o.e);
                  obj = new fabric.Ellipse({
                     strokeWidth: 2,
                     fill: 'rgba(255, 255, 255, .25)',
                     stroke: 'rgba(0, 0, 0, .75)',
                     top: pointer.y,
                     left: pointer.x,
                     originY: 'top',
                     originX: 'left',
                     selectable: false,
                     rx: 1,
                     ry: 1,
                     perPixelTargetFind: true
                  });
                  canvas.add(obj);
               },
               mouseMove: function(o) {
                  if (!isMouseDown) {
                     return;
                  }
                  var currentPointer = canvas.getPointer(o.e);
                  obj.set({
                     rx: Math.abs(currentPointer.x - pointer.x),
                     ry: Math.abs(currentPointer.y - pointer.y)
                  });
                  canvas.renderAll();
               },
               mouseUp: function(o) {
                  isMouseDown = false;
                  obj.set({
                     width: obj.rx * 2,
                     height: obj.ry * 2,
                     top: obj.top - obj.ry + 1,
                     left: obj.left - obj.rx + 1
                  });
                  canvas.renderAll();
                  canvas.fire('object:modified', { target: obj });
               }
            };

            var lineHandler = {
               mouseDown: function(o) {
                  canvas.calcOffset();
                  isMouseDown = true;
                  pointer = canvas.getPointer(o.e);
                  obj = new fabric.Line([pointer.x, pointer.y, pointer.x, pointer.y], {
                     strokeWidth: 2,
                     stroke: 'rgba(0, 0, 0, 0.75)',
                     originX: 'center',
                     originY: 'center',
                     selectable: false,
                     perPixelTargetFind: true
                  });
                  canvas.add(obj);
               },
               mouseMove: function(o) {
                  if (!isMouseDown) {
                     return;
                  }
                  pointer = canvas.getPointer(o.e);
                  obj.set({
                     x2: pointer.x,
                     y2: pointer.y
                  });
                  canvas.renderAll();
               },
               mouseUp: function(o) {
                  isMouseDown = false;
                  canvas.fire('object:modified', { target: obj });
               }
            };

            var typeHandler = {
               init: function() {
                  canvas.defaultCursor = 'text';
                  canvas.on('text:editing:exited', function(e) {
                     if (!e.target.text) {
                        canvas.remove(e.target);
                     } else {
                        canvas.fire('object:modified', { target: e.target });
                     }
                  });
                  canvas.getObjects().forEach(function(obj) {
                     if (obj.get('type') === 'i-text') {
                        obj.set({
                           selectable: true,
                           editable: true
                        });
                     }
                  });
               },
               mouseDown: function(o) {
                  canvas.calcOffset();
                  isMouseDown = true;
                  pointer = canvas.getPointer(o.e);
                  var isInsideTextObject = false;
                  canvas.getObjects().forEach(function(objOnCanvas) {
                     if (objOnCanvas.get('type') === 'i-text') {
                        var bounds = objOnCanvas.getBoundingRect();
                        if (
                           pointer.x >= bounds.left
                           && pointer.x <= bounds.left + bounds.width
                           && pointer.y >= bounds.top
                           && pointer.y <= bounds.top + bounds.height
                        ) {
                           objOnCanvas.enterEditing();
                           isInsideTextObject = true;
                           obj = null;
                        }
                     }
                  });
                  if (!isInsideTextObject) {
                     obj = new fabric.IText('', {
                        fontFamily: 'Roboto',
                        selectable: false,
                        originX: 'center',
                        originY: 'center',
                        lockUniScaling: true,
                        textAlign: 'center',
                        fontSize: 24,
                        fontWeight: 300,
                        fill: 'rgba(0, 0, 0, 1)'
                     });
                  }
               },
               mouseMove: function() {},
               mouseUp: function(o) {
                  isMouseDown = false;
                  if (obj) {
                     pointer = canvas.getPointer(o.e);
                     obj.set({
                        top: pointer.y,
                        left: pointer.x
                     });
                     canvas.add(obj);
                     canvas.setActiveObject(obj);
                     obj.enterEditing();
                     canvas.renderAll();
                  }
               }
            };

            canvasWrapper.querySelector('.j-canvas-select').addEventListener('click', function() {
               (activateTool.bind(this))(selectHandler);
            });

            canvasWrapper.querySelector('.j-canvas-paint').addEventListener('click', function() {
               (activateTool.bind(this))(paintHandler);
            });

            canvasWrapper.querySelector('.j-canvas-rect').addEventListener('click', function() {
               (activateTool.bind(this))(rectHandler);
            });

            canvasWrapper.querySelector('.j-canvas-circle').addEventListener('click', function() {
               (activateTool.bind(this))(circleHandler);
            });

            canvasWrapper.querySelector('.j-canvas-line').addEventListener('click', function() {
               (activateTool.bind(this))(lineHandler);
            });

            canvasWrapper.querySelector('.j-canvas-type').addEventListener('click', function() {
               (activateTool.bind(this))(typeHandler);
            });

            canvasWrapper.querySelector('.j-canvas-undo').addEventListener('click', function() {
               History.undo();
               if (History.canUndo()) {
                  canvasWrapper.querySelector('.j-canvas-undo').classList.remove('j-disabled');
               } else {
                  canvasWrapper.querySelector('.j-canvas-undo').classList.add('j-disabled');
               }
               if (History.canRedo()) {
                  canvasWrapper.querySelector('.j-canvas-redo').classList.remove('j-disabled');
               } else {
                  canvasWrapper.querySelector('.j-canvas-redo').classList.add('j-disabled');
               }
            });

            canvasWrapper.querySelector('.j-canvas-redo').addEventListener('click', function() {
               History.redo();
               if (History.canUndo()) {
                  canvasWrapper.querySelector('.j-canvas-undo').classList.remove('j-disabled');
               } else {
                  canvasWrapper.querySelector('.j-canvas-undo').classList.add('j-disabled');
               }
               if (History.canRedo()) {
                  canvasWrapper.querySelector('.j-canvas-redo').classList.remove('j-disabled');
               } else {
                  canvasWrapper.querySelector('.j-canvas-redo').classList.add('j-disabled');
               }
            });

            canvasWrapper.querySelector('.j-canvas-remove').addEventListener('click', function() {
               if (canvas.getActiveObject()) {
                  canvas.remove(canvas.getActiveObject());
               } else if (canvas.getActiveGroup()) {
                  canvas.getActiveGroup().forEachObject(function(obj) {
                     canvas.remove(obj);
                  });
                  canvas.discardActiveGroup();
               }
               canvas.renderAll();
               canvas.fire('object:modified', { target: obj });
            });

            canvas.on('object:modified', function(e) {
               if (History.canUndo()) {
                  canvasWrapper.querySelector('.j-canvas-undo').classList.remove('j-disabled');
               } else {
                  canvasWrapper.querySelector('.j-canvas-undo').classList.add('j-disabled');
               }
               if (History.canRedo()) {
                  canvasWrapper.querySelector('.j-canvas-redo').classList.remove('j-disabled');
               } else {
                  canvasWrapper.querySelector('.j-canvas-redo').classList.add('j-disabled');
               }
            });

            canvas.on('object:selected', function(e) {
               canvasWrapper.querySelector('.j-canvas-remove').classList.remove('j-disabled');
            });

            canvas.on('selection:cleared', function(e) {
               canvasWrapper.querySelector('.j-canvas-remove').classList.add('j-disabled');
            });

            window.addEventListener('keydown', function(e) {
               if (e.keyCode == 46) {
                  if (canvas.getActiveObject()) {
                     e.preventDefault();
                     canvas.remove(canvas.getActiveObject());
                  } else if (canvas.getActiveGroup()) {
                     e.preventDefault();
                     canvas.getActiveGroup().forEachObject(function(obj) {
                        canvas.remove(obj);
                     });
                     canvas.discardActiveGroup();
                  }
                  canvas.renderAll();
                  canvas.fire('object:modified', { target: obj });
               }
            });

            /*canvas.setBackgroundImage('img/icon/exams.svg', canvas.renderAll.bind(canvas), {
               width: canvas.width,
               height: canvas.height,
               originX: 'left',
               originY: 'top'
            });*/

            /*fabric.loadSVGFromURL('img/icon/exams.svg', function(objects, options) {
               var obj = fabric.util.groupSVGElements(objects, options);
               obj.set({
                  left: 0,
                  top: 0,
                  scaleX: canvas.width / obj.width,
                  scaleY: canvas.height / obj.height
               });
               obj.set('selectable', false);
               canvas.add(obj).sendToBack(obj).renderAll();
            });*/

         });

      }
   });

</script>
</body>
</html>